<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/chart-elements/chart-doughnut.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="moment.html">
<link rel="import" href="lodash.html">
<link rel="import" href="lf-money.html">
<link rel="import" href="material-table-styles.html">

<dom-module id="lf-cycle">

    <template>        

        <style include="material-table-styles iron-flex iron-flex-alignment"></style>
        <style>
            :host {
                display: block;
            }

            nav {                
                background-color: var(--paper-cyan-500);
                text-transform: uppercase;
            }

            paper-tabs {                
                --paper-tabs-selection-bar-color: var(--paper-blue-grey-600);
            }

            .filter-button {
                @apply(--layout-self-center);
            }

            .main {
                padding: 16px;
            }

            .avatar {
                display: inline-block;
                box-sizing: border-box;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background: var(--paper-cyan-200);
            }

            .percentage {           
                width: 70px;
                padding-top: 0px;
                text-align: right;
                font-size: 20px;
            }

            paper-progress {
                width: 100%;
            }

            paper-progress.expense {
                --paper-progress-active-color: var(--paper-red-400);
                --paper-progress-secondary-color: var(--paper-red-100);
            }

            paper-progress.income {
                --paper-progress-active-color: var(--paper-light-green-400);
                --paper-progress-secondary-color: var(--paper-light-green-100);
            }

            .header {               
                border-bottom-width: 3px;
                border-bottom-color: var(--paper-grey-300);
                border-bottom-style: solid; 
            }

            paper-material {
                @apply(--layout-self-start);
                margin: 0px 5px;
            }
        </style>

        <nav class="horizontal layout justified">
            <paper-tabs noink selected="{{weekId}}" scrollable class="flex">
                <template is="dom-repeat" items="{{weeks}}">
                    <paper-tab>{{item.start}} - {{item.end}}</paper-tab>
                </template>
            </paper-tabs>
            <paper-icon-button icon="filter-list" class="filter-button"></paper-icon-button>
        </nav>

        <div class="main horizontal layout">
            <paper-material elevation="1" class="flex">
                <paper-listbox>
                    <paper-icon-item class="header">
                        <div class="avatar" item-icon></div>
                        <paper-item-body two-line>
                        <div class="horizontal layout justified">
                            <span>{{total.category}}</span>
                            <lf-money amount="{{total.amount}}"></lf-money>
                        </div>
                        <div secondary>
                            <paper-progress value="{{total.amount}}" class="expense" min="0" max="{{total.amount}}"></paper-progress>
                        </div>
                        </paper-item-body>
                        <div class="percentage">{{total.percentage}}%</div>
                    </paper-icon-item>
                    <template is="dom-repeat" items="{{groups}}">
                        <paper-icon-item>
                            <div class="avatar" item-icon></div>
                            <paper-item-body two-line>
                            <div class="horizontal layout justified">
                                <span>{{item.category}}</span>
                                <lf-money amount="{{item.amount}}"></lf-money>
                            </div>
                            <div secondary>
                                <paper-progress value="{{item.amount}}" class$="{{item.type}}" min="0" max="{{total.amount}}"></paper-progress>
                            </div>
                            </paper-item-body>
                            <div class="percentage">{{item.percentage}}%</div>
                        </paper-icon-item>
                    </template>
                </paper-listbox>
            </paper-material>
            <paper-material elevation="1" class="flex">
                <table>
                    <thead>
                        <tr>
                            <th></th>
                            <th class="right">{{week.start}}</th>
                            <th class="right">Transactions</th>
                            <th class="right">{{week.end}}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template is="dom-repeat" items="{{accounts}}">
                            <tr>
                                <td>{{item.name}}</td>
                                <td class="right"><lf-money amount="{{item.before}}"></lf-money></td>
                                <td class="right"><lf-money amount="{{item.diff}}"></lf-money></td>
                                <td class="right"><lf-money amount="{{item.after}}"></lf-money></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </paper-material>
        </div>
        
    </template>

    <script>
        Polymer({
            is: 'lf-cycle',
            properties: {
                app: Object,
            },

            observers: [
                "_load(app.records.splices)",
                "_weekChange(weekId)",
            ],

            _load: function() {
                this.weeks = this._getWeeks();
                this.weekId = 11;
                this._reload();
            },

            _weekChange: function() {
                this.week = this.weeks[this.weekId];
                this._reload();
            },

            _reload: function() {
                if (!this.app.records) return;
                this.groups = this._getGroups();
                this.accounts = this._getAccounts();
            },

            _getWeeks: function() {
                var t = 12;
                var startingDay = 6; //Saturday
                var range = _.reverse(_.range(t));

                return _.map(range, function(i) {
                    var start = moment().day(startingDay - (7 * (i+1))) 
                    var end = start.clone().add(7, 'd');
                    var startTs = start.toDate().getTime();
                    var endTs = end.toDate().getTime();
                    return {
                        index: i,
                        start: start.format("MMM D"),
                        startTs: startTs,
                        end: end.format("MMM D"),
                        endTs: endTs
                    };                    
                });
            },

            _getGroups: function() {
                var self = this;
                var records = this.app.records;            

                var expenses = _.filter(records, ["type", "expense"]);
                var grouped = _.groupBy(expenses, "category");
                var groups = _.map(grouped, function(records, category){
                    var sum = _.sumBy(records, "amount");
                    return {
                        category: category,
                        amount: sum,
                        type: "expense"
                    };                    
                });

                groups = _.orderBy(groups, "amount", "desc");

                self.total = {
                    category: "Total",
                    amount: _.sumBy(groups, "amount"),
                    type: "expense",
                    percentage: 100
                };

                _.forEach(groups, function(g) {
                    g.percentage = Math.round(100 * g.amount / self.total.amount); 
                });

                return groups;
            },

            _getAccounts: function() {
                var self = this;
                var accounts = self.app.user.accounts;
                var week = self.week;
                return _.map(accounts, function(account){
                    var before = self.app.getBalanceBefore(account, week.startTs);
                    var after = self.app.getBalanceBefore(account, week.endTs);
                    return {
                        name: account.name,
                        before: before,
                        after: after,
                        diff: after - before
                    };
                });
            },

        });
    </script>

</dom-module>