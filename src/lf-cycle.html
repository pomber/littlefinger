<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/chart-elements/chart-doughnut.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="moment.html">
<link rel="import" href="lodash.html">
<link rel="import" href="material-table-styles.html">

<dom-module id="lf-cycle">

    <template>        

        <style include="material-table-styles iron-flex iron-flex-alignment"></style>
        <style>
            :host {
                display: block;
            }

            nav {                
                background-color: var(--paper-cyan-400);
                text-transform: uppercase;
            }

            paper-tabs {                
                --paper-tabs-selection-bar-color: var(--paper-blue-grey-600);
            }

            .filter-button {
                @apply(--layout-self-center);
            }

            section {
                padding: 16px;
            }

            .avatar {
                display: inline-block;
                box-sizing: border-box;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background: var(--paper-cyan-200);
            }
            paper-progress {
                width: 100%;
            }

            paper-progress.expense {
                --paper-progress-active-color: var(--paper-red-400);
                --paper-progress-secondary-color: var(--paper-red-100);
            }

            paper-progress.income {
                --paper-progress-active-color: var(--paper-light-green-400);
                --paper-progress-secondary-color: var(--paper-light-green-100);
            }
        </style>

        <nav class="horizontal layout justified">
            <paper-tabs noink selected="12" attr-for-selected="name" scrollable class="flex">
                <template is="dom-repeat" items="{{weeks}}">
                    <paper-tab name="{{item.index}}">{{item.start}} - {{item.end}}</paper-tab>
                </template>
            </paper-tabs>
            <paper-icon-button icon="filter-list" class="filter-button"></paper-icon-button>
        </nav>

        <section>
            <paper-material elevation="1">
                <paper-listbox>
                    <template is="dom-repeat" items="{{groups}}">
                        <paper-icon-item>
                            <div class="avatar" item-icon></div>
                            <paper-item-body two-line>
                            <div class="horizontal layout justified">
                                <span>{{item.category}}</span>
                                <span>${{item.amount}}</span>
                            </div>
                            <div secondary>
                                <paper-progress value="{{item.amount}}" class$="{{item.type}}" min="0" max="{{total}}" class="red"></paper-progress>
                            </div>
                            </paper-item-body>
                            <!--<paper-icon-button icon="star" alt="favourite this!">
                            </paper-icon-button>-->
                        </paper-icon-item>
                    </template>
                </paper-listbox>
            </paper-material>
        </section>
        
    </template>

    <script>
        Polymer({
            is: 'lf-cycle',
            properties: {
                app: Object,
            },

            observers: [
                "_load(app.records.splices)"
            ],

            _load: function() {
                if (!this.app.records) return;
                this.weeks = this._getWeeks();
                this.groups = this._getGroups();
            },

            _getWeeks: function() {
                var t = 12;
                var startingDay = 6; //Saturday
                var range = _.reverse(_.range(t));

                return _.map(range, function(i) {
                    var start = moment().day(startingDay - (7 * (i+1))) 
                    var end = start.clone().add(7, 'd');
                    var startTs = start.toDate().getTime();
                    var endTs = end.toDate().getTime();
                    return {
                        index: i,
                        start: start.format("MMM D"),
                        end: end.format("MMM D")
                    };                    
                });
            },

            _getGroups: function() {
                var self = this;
                var records = this.app.records;
                var categories = this.app.user.categories;
                var groups = _.map(categories, function(category, key){
                    var sub = _.filter(records, ["category", category.name]);
                    var sum = _.sumBy(sub, "amount");
                    return {
                        category: category.name,
                        amount: sum,
                        type: category.type,
                    };
                });

                groups = _.filter(groups, "amount");
                groups = _.orderBy(groups, "amount", "desc");
                this.total = _.sumBy(groups, "amount");

                return groups;
            }

        });
    </script>

</dom-module>